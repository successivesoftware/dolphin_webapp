/**
* Created by successive on 20/10/15.
**/


<link rel="import" href="..\..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\..\bower_components/paper-input/paper-input.html"/>
<link rel="import" href="..\..\..\bower_components/paper-button/paper-button.html"/>
<link rel="import" href="..\..\..\bower_components/paper-checkbox/paper-checkbox.html"/>
<link rel="import" href="..\..\..\bower_components/paper-material/paper-material.html"/>
<link rel="import" href="..\..\..\bower_components/iron-form/iron-form.html"/>
<link rel="import" href="..\..\..\bower_components/iron-a11y-keys/iron-a11y-keys.html"/>
<link rel="import" href="..\..\..\bower_components/polymer-cookie/polymer-cookie.html"/>


<dom-module id="auth-dialog">
  <link rel="stylesheet" href="..\..\..\styles/authassets/css/main.css"/>
  <link rel="stylesheet" href="..\..\..\styles/authassets/css/position.css"/>
  <link rel="stylesheet" href="..\..\..\styles/authassets/css/skins/default/colors.css"/>
  <link rel="stylesheet" href="..\..\..\styles/authassets/css/auth.css"/>
  <template>
    <style>

      :host {
        display: block;
        --paper-input-container-focus-color: #00b6b6;
      }

      paper-button {
        display: block;
        width: 100%;
        background-color: #00b6b6;
      }

      paper-material {
        background-color: white;
        padding: 2em;
        margin: 13em 30em;
      }

      @media (max-width: 621px) {
        paper-material {
          background-color: white;
          padding: 2em;
          margin: 15em 2em;
        }
      }

      @media (min-width: 622px) and (max-width: 992px) {
        paper-material {
          background-color: white;
          padding: 2em;
          margin: 10em 15em;
        }
      }
    </style>
    <iron-ajax
      id="login"
      url="http://localhost:9000/api/auth"
      method="POST"
      on-response="handleResponse"
      content-type="application/json"
      handle-as="json"
      on-error="handleError"
      last-response="{{ajaxResponse}}"></iron-ajax>
    <paper-material elevation="3">
      <h3>Dolphin Webapp Login</h3>

      <div class="horizontal-section">
        <paper-input id="username" label="Username" autofocus required></paper-input>
        <paper-input id="password" type="password" label="Password" required></paper-input>
        <br>
        <br>
        <!--<paper-checkbox on-click="">Remember me</paper-checkbox>-->
        <paper-button raised on-click="login">Login</paper-button>

      </div>
    </paper-material>


  </template>
</dom-module>

<script>

  Polymer({
    is: 'auth-dialog',
    properties: {

      provider: {
        type: String,
        value: 'password'
      },

      hideLogin: {
        type: Boolean,
        value: false
      },

      hideSignup: {
        type: Boolean,
        value: true
      },

      hideResetPassword: {
        type: Boolean,
        value: true
      },

      message: {
        type: String,
        value: ''
      },
      email: {
        type: String,
        value: ''
      },
      password: {
        type: String,
        value: ''
      },

      cookieVal: {
        type: String,
        value: ''
      },

      user: {
        type: Object,
        value: null
      },
      statusKnown: {
        type: Boolean
      }
    },
    ready: function () {
      console.log(this);
    },
    login: function () {
      var username = document.getElementById('username').value;
      var password = document.getElementById('password').value;
      var userdata = {
        username: username,
        password: password
      };
      var ajax_request = document.getElementById('login');
      ajax_request.body = userdata;
      ajax_request.generateRequest();
    },
    createCookie: function (name, value, days) {

      if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        var expires = "; expires=" + date.toGMTString();
      } else {
        var expires = "";
      }

      document.cookie = name + "=" + value + expires + "; path=/";

      if (value != null && value != '') {
        window.location.replace(window.location.origin);
      }
    },
    getQueryParams: function (qs) {
      qs = qs.split('+').join(' ');

      var params = {},
        tokens,
        re = /[?&]?([^=]+)=([^&]*)/g;

      while (tokens = re.exec(qs)) {
        params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);
      }

      return params;
    },
    handleResponse: function (request) {
      var user = request.detail.response;
      console.log(request.detail.response);
      this.createCookie("userid", user.userName, 1);
    },
    handleError: function (err) {
      alert('Invalid username or password');
    }
  });
  </script>
